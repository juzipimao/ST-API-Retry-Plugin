# SillyTavern API空内容重试插件

## 功能简介

为 SillyTavern 提供针对“空/过短响应”的自动重试，并支持按 API 白名单精确拦截。适用于偶发空白回复、网络抖动或模型短输出的场景。

## 主要特性

- 智能判空: 识别空字符串、纯空白、以及“少于 Token 阈值”的短输出（默认 400）。
- 指数退避: 每次重试等待时间翻倍，避免打爆服务器。
- API 白名单: 仅对命中的 URL 进行重试；支持大小写不敏感的“包含匹配”和正则规则。
- 内置弹窗: 重试用尽后，使用 SillyTavern 自带弹窗显示原始错误，并抛出原始异常。
- 可视提示: 每次即将重试时弹蓝色提示框，显示“第 N/总次数、等待 Zms”。
- 持久设置: 全部选项保存在浏览器，尊重你的选择（首次安装按默认，之后不覆盖）。
- 轻量友好: 与核心 UI 风格一致，默认面板收起，按钮横向展示。

## 安装
- 添加扩展:"https://github.com/juzipimao/ST-API-Retry-Plugin" 或者下面手动
- 复制本目录到：`SillyTavern/data/default-user/extensions/ST-API-Retry-Plugin/`
- 刷新页面，打开“扩展”→ 找到“API空内容重试设置”

## 设置项

- 启用空内容重试: 主开关。
- 最大重试次数: 1–10。
- 基础延迟(毫秒): 首次重试等待；后续按 2^n 增长。
- 检查纯空白字符: 仅空白（空格/换行）也视为空响应。
- 少于 Token 阈值时重试: 默认开启；阈值默认 400。
  - 计数方式: 优先解析常见字段（如 `choices[].message.content`、`output_text` 等）并使用当前模型分词器；不可用时回退字符比率估算。
- API 拦截管理: 仅命中规则才会应用重试（白名单）。
  - 添加规则: 支持两种形式：
    - 子串包含（不区分大小写）：示例 `love.qinyan`、`/chat-completions/generate`
    - 正则：以 `/.../` 包裹，如 `/\\/api\\/openai\\//`
  - 规则列表: 支持编辑、删除；点击“插入默认规则”快速加入 `/chat-completions/generate`（不会刷新页面，且自动去重）。

提示
- 规则为空时：不拦截任何请求（不重试）。
- 首次安装：默认勾选“少于 Token 阈值重试(400)”。你手动修改后，刷新不再被默认覆盖。
- 每次重试前：会弹蓝色提示展示第几次与等待时长。
- 重试用尽：弹出内置错误框，错误原样抛出（便于上层捕获）。

## 工作原理

- 拦截 `window.fetch` → 命中白名单规则的请求才进入增强逻辑。
- 判定“空/短输出”→ 满足任一条件即触发重试：
  - 纯空白内容（或 `null/undefined`）
  - 少于 Token 阈值（默认 400）
- 重试采用指数退避；成功则返回原始响应。

## 常见问题

- 按钮竖排: 本扩展已内置作用域样式，按钮会横向展示；无需改全局样式。
- 面板默认展开: 已改为默认收起；点击标题使用酒馆内置折叠逻辑。
- 规则不生效/不保存: 规则会保存到 `extension_settings`，请确认浏览器未禁用本地存储；插入/编辑/删除后会自动保存。

## 版本

- 当前版本: 1.0.0
- 兼容性: SillyTavern 1.10+
- 作者: DayBreak

### 变更摘要（1.2.0）
- 新增 API 白名单拦截（大小写不敏感包含匹配/正则）。
- 新增 Token 阈值重试（默认开启，阈值 400）。
- 重试用尽使用内置错误弹窗并抛出原始错误。
- 每次重试前弹蓝色提示，展示第 N/总次数与延迟。
- 面板默认收起，按钮横向展示；UI 与酒馆一致。
