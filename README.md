# SillyTavern API空内容重试插件

## 功能简介

这是一个专门为SillyTavern设计的轻量级API重试插件，专注于检测和重试返回空内容的API响应。当AI模型返回空白或过短的响应时，插件会自动重试请求，确保获得有意义的内容。

## 主要特性

✅ **智能空内容检测** - 检测空字符串、纯空白字符和过短的响应  
✅ **指数退避重试** - 使用科学的重试策略，避免频繁请求  
✅ **完全中文界面** - 所有设置和提示均为中文  
✅ **灵活配置选项** - 可自定义重试次数、延迟时间等参数  
✅ **实时状态反馈** - 提供详细的日志和Toast通知  
✅ **轻量级设计** - 只关注核心功能，不影响系统性能  

## 安装方法

1. 将整个插件文件夹复制到 SillyTavern 的扩展目录：
   ```
   SillyTavern/data/default-user/extensions/ST-API-Retry-Plugin/
   ```

2. 重启 SillyTavern 或刷新页面

3. 在扩展设置中找到"API空内容重试设置"面板

## 设置说明

### 基础设置
- **启用空内容重试**: 主开关，控制插件是否生效
- **最大重试次数**: 遇到空内容时的最大重试次数（1-10次）
- **基础延迟**: 首次重试的延迟时间，后续会按指数增长

### 检测设置
- **最小内容长度**: 低于此长度的响应将被视为空内容
- **检查纯空白字符内容**: 是否将只包含空格、换行等的响应视为空内容

### 调试设置
- **启用控制台日志**: 在浏览器控制台输出详细的重试日志

## 工作原理

1. **请求拦截**: 插件通过monkey-patch技术拦截所有fetch请求
2. **内容检测**: 检查API响应内容是否符合"空内容"的条件
3. **智能重试**: 如果检测到空内容，使用指数退避算法进行重试
4. **状态通知**: 通过Toast消息和控制台日志提供实时反馈

## 空内容判断条件

响应被视为空内容的条件：
- 响应为 `null`、`undefined` 或空字符串
- 响应内容长度小于设定的最小长度
- 响应内容去除空白字符后为空（如果启用此选项）

## 重试策略

使用指数退避算法：
- 第1次重试：基础延迟
- 第2次重试：基础延迟 × 2
- 第3次重试：基础延迟 × 4
- 以此类推...

这样可以避免频繁请求，同时给服务器恢复的时间。

## 注意事项

⚠️ **重要提醒**：
- 本插件会拦截所有网络请求，请在稳定的网络环境下使用
- 如果遇到问题，可以通过关闭"启用空内容重试"开关来停用
- 建议重试次数不要设置过高，避免占用过多资源

## 故障排除

### 插件不生效
1. 检查插件是否正确安装在扩展目录
2. 确认"启用空内容重试"开关已开启
3. 查看浏览器控制台是否有错误信息

### 重试过于频繁
1. 适当增加"基础延迟"时间
2. 检查"最小内容长度"设置是否过于严格
3. 关闭"检查纯空白字符内容"选项

## 技术特点

- **轻量级架构**: 只实现核心重试功能，代码简洁高效
- **非侵入式**: 使用标准的fetch拦截，不影响其他功能
- **错误恢复**: 如果重试全部失败，会恢复到原始错误状态
- **内存安全**: 正确处理响应克隆，避免内存泄漏

## 版本信息

**当前版本**: 1.0.0  
**兼容性**: SillyTavern 1.10+  
**开发者**: Claude Code  

---

*本插件基于 Hikarushmz/fetch-retry 项目的思路开发，专注于空内容重试功能的优化实现。*